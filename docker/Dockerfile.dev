FROM node:22-alpine

WORKDIR /app

ENV PNPM_HOME=/root/.local/share/pnpm
ENV	PATH=$PNPM_HOME:$PATH

# Configure pnpm version via Corepack and copy dependency manifests
ARG PNPM_VERSION=10.17.1
RUN corepack enable && corepack prepare pnpm@${PNPM_VERSION} --activate
COPY package.json pnpm-lock.yaml ./

# Install dependencies (pnpm) with cache mount for store (BuildKit)
RUN --mount=type=cache,id=pnpm-store,target=/root/.local/share/pnpm/store \
	pnpm install --frozen-lockfile

# Approve native build scripts
RUN pnpm approve-builds

# Expose the port the app runs on
EXPOSE 3000

USER node

# Start development server
CMD ["corepack", "pnpm", "dev"]
